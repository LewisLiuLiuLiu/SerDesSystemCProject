# CDR 模块技术文档

**级别**：AMS 子模块（RX）  
**类名**：`RxCdrTdf`  
**当前版本**：v0.1 (2026-01-07)  
**状态**：开发中

---

## 1. 概述

时钟数据恢复（CDR，Clock and Data Recovery）是SerDes接收端的核心模块，主要功能是从接收到的数据流中恢复时钟信息，并生成最佳采样相位，确保采样器在眼图最佳位置采样数据，从而最大化系统的误码容限。

### 1.1 设计原理

CDR的核心设计思想是利用数据跃变边沿携带的时钟信息，通过闭环反馈机制动态调整采样相位：

- **相位检测**：检测数据跃变边沿与当前采样时钟的相位关系，提取相位误差信息
- **环路滤波**：通过比例-积分（PI）控制器处理相位误差，抑制高频抖动，稳定环路
- **相位调整**：将滤波后的相位校正信号输出给采样器，实现动态相位跟踪

本模块采用经典的Bang-Bang相位检测器（BBPD）+ PI数字环路滤波器架构：

```
数据输入 → 边沿检测 → Bang-Bang相位检测器 → PI控制器 → 相位输出
           ↑                                              ↓
           └──────────────────相位反馈──────────────────────┘
```

相位检测器输出离散的早/晚（Early/Late）信号，经过PI控制器积分平均后转换为连续的相位调整量，输出给采样器的`phase_offset`端口。

### 1.2 核心特性

- **Bang-Bang相位检测**：基于数据跃变边沿的二值相位误差检测
- **数字PI环路滤波器**：可配置的比例增益（Kp）和积分增益（Ki）
- **相位范围限制**：可配置的相位调整范围和分辨率
- **与采样器协同**：输出相位调整信号（单位：秒），直接驱动采样器相位偏移
- **简化的实现**：当前版本为行为级模型，适用于系统级仿真和算法验证

### 1.3 版本历史

| 版本 | 日期 | 主要变更 |
|------|------|----------|
| v0.1 | 2026-01-07 | 初始版本，Bang-Bang PD + PI控制器（简化实现，存在已知bug） |

> **重要说明**：当前版本实现存在已知问题（端口命名不一致、PI控制器公式不完整），仅用于架构验证。后续版本将修复这些问题并增强功能（频率检测器、锁定检测器、自适应带宽切换等）。

---

## 2. 模块接口

### 2.1 端口定义（TDF域）

| 端口名 | 方向 | 类型 | 说明 |
|-------|------|------|------|
| `in` | 输入 | double | 接收数据输入（模拟信号，来自DFE或采样器） |
| `phase_out` | 输出 | double | 相位调整输出（单位：秒s） |

> ⚠️ **端口命名不一致警告**：
> - **文档中**的端口名为`phase_out`（如上表所示）
> - **代码中**的端口初始化使用了`out`（在`rx_cdr.cpp`构造函数中）
> - 这会导致编译错误，实际使用时需确认代码已修正为`phase_out`
> - 本文档以正确的`phase_out`命名为准

> **端口说明**：
> - `in`端口接收连续的模拟信号，CDR从数据跃变中提取时钟信息
> - `phase_out`端口输出相位偏移量（单位：秒），连接到采样器的`phase_offset`输入端口
> - 正值表示延迟采样（时钟晚），负值表示提前采样（时钟早）

### 2.2 参数配置

CDR模块的参数通过`CdrParams`结构体配置，包含两个子结构：PI控制器参数和相位插值器参数。

#### 2.2.1 PI控制器参数（CdrPiParams）

| 参数名 | 类型 | 默认值 | 说明 |
|-------|------|--------|------|
| `kp` | double | 0.01 | 比例增益（Proportional Gain） |
| `ki` | double | 1e-4 | 积分增益（Integral Gain） |

**工作原理**：

PI控制器是二阶数字环路滤波器，标准的离散时间公式为：
```
积分状态: I[n] = I[n-1] + Ki × e[n]
PI输出:    φ[n] = Kp × e[n] + I[n]
```
其中：
- `φ[n]`：第n个采样时刻的输出相位
- `e[n]`：相位误差（Bang-Bang PD输出±1）
- `I[n]`：积分状态（历史误差累积）
- `Kp`：比例增益，控制瞬态响应速度
- `Ki`：积分增益，消除稳态相位误差

> ⚠️ **当前代码实现存在Bug**：源文件`rx_cdr.cpp`中的实现将比例项和积分项都累加到`m_phase`，导致比例项也被错误地积分，不符合标准PI控制器设计。正确的实现应分离积分状态和比例项（见3.3节详细说明）。

**参数调节指南**：

- **Kp（比例增益）**：
  - 增大Kp加快相位锁定速度，但过大会导致振荡
  - 典型范围：0.001 ~ 0.1
  - 默认值0.01适用于10Gbps系统

- **Ki（积分增益）**：
  - 增大Ki提升跟踪精度，但过大会降低环路稳定性
  - 典型关系：Ki ≈ Kp/10 ~ Kp/100
  - 默认值1e-4与Kp=0.01匹配

**环路特性**：

二阶PI环路的自然频率ωn和阻尼系数ζ由Kp和Ki决定（基于线性化分析）：
```
ωn = √(Ki × Fs)
ζ = Kp / (2 × ωn)
```
其中Fs为采样率。推荐ζ在0.7~1.0之间以获得最佳阶跃响应。

> ⚠️ **重要提示**：上述公式基于**线性相位检测器**的假设，通过连续时间域的线性化推导得出。但本模块采用的是**Bang-Bang相位检测器**（输出离散的±1），其非线性特性导致实际环路行为与线性理论有偏差：
> - Bang-Bang PD缺乏线性区间，无法提供连续的相位误差信息
> - 实际的环路带宽和阻尼系数会偏离理论计算值
> - 离散二值输出会引入额外的相位抖动（参见7.2节）
> 
> 因此，这些公式仅作为**初步设计的近似估算**，实际参数需通过仿真验证和调优。

#### 2.2.2 相位插值器参数（CdrPaiParams）

| 参数名 | 类型 | 默认值 | 说明 |
|-------|------|--------|------|
| `resolution` | double | 1e-12 | 相位调整分辨率（单位：秒s） |
| `range` | double | 5e-11 | 相位调整范围（单位：秒s） |

**工作原理**：

相位插值器（Phase Interpolator）将数字环路滤波器输出的相位控制字转换为实际的时间偏移。

- **分辨率（resolution）**：
  - 定义相位调整的最小步进
  - 默认1ps（1e-12秒）对应高精度硬件实现
  - 物理意义：硬件相位插值器的DNL（微分非线性度）
  - 更粗的分辨率（如5ps）可模拟低成本实现

- **范围（range）**：
  - 定义相位调整的最大偏移量（±range）
  - 默认50ps（±25ps）足以覆盖典型频偏和抖动
  - 物理意义：相位插值器的线性范围
  - 应大于预期的最大频率偏移 × UI

**实际应用示例**：

对于10Gbps系统（UI = 100ps）：
- 频偏±500ppm → 最大相位偏移 = ±50ps → range设置≥50ps
- 硬件相位插值器6-bit → 分辨率 = UI/64 ≈ 1.5ps

#### 2.2.3 完整参数结构

```cpp
struct CdrParams {
    CdrPiParams pi;      // PI控制器参数
    CdrPaiParams pai;    // 相位插值器参数
};
```

**JSON配置示例**：

```json
{
  "rx": {
    "cdr": {
      "pi": {
        "kp": 0.01,
        "ki": 1e-4
      },
      "pai": {
        "resolution": 1e-12,
        "range": 5e-11
      }
    }
  }
}
```

### 2.3 端口连接示例

CDR模块通常连接在采样器或DFE之后，输出相位信号反馈给采样器：

```cpp
// 实例化CDR模块
CdrParams cdr_params;
cdr_params.pi.kp = 0.01;
cdr_params.pi.ki = 1e-4;
RxCdrTdf cdr("cdr", cdr_params);

// 连接信号
cdr.in(data_signal);              // 来自DFE或采样器
cdr.phase_out(phase_adjust_sig);  // 输出到采样器的phase_offset端口

// 采样器连接（闭环）
sampler.phase_offset(phase_adjust_sig);  // 接收CDR相位调整
sampler.data_out(sampled_data);
cdr.in(sampled_data);  // 或连接到均衡后的模拟信号
```

---

## 3. 核心实现机制

### 3.1 信号处理流程

CDR模块的`processing()`方法实现以下处理步骤：

```
步骤1: 读取输入数据 → 步骤2: 边沿检测 → 步骤3: Bang-Bang相位检测 → 
步骤4: PI控制器更新 → 步骤5: 相位范围限制 → 步骤6: 输出相位调整
```

**步骤1 - 读取输入数据**：从`in`端口读取当前采样点的数据信号。

**步骤2 - 边沿检测**：通过比较当前比特与前一比特，检测数据跃变：
```cpp
double current_bit = in.read();
if (std::abs(current_bit - m_prev_bit) > threshold) {
    // 检测到边沿
}
```

**步骤3 - Bang-Bang相位检测**：在检测到边沿时，判断相位早晚：
- 如果 `current_bit > m_prev_bit`（上升沿）→ 相位误差 = +1（时钟晚）
- 如果 `current_bit < m_prev_bit`（下降沿）→ 相位误差 = -1（时钟早）
- 无边沿时相位误差 = 0

> ⚠️ **简化实现的错误**：
> - 上述逻辑是**错误的简化**，不符合真实的Bang-Bang相位检测器工作原理
> - 真实的BBPD需要使用**数据采样器和边沿采样器的异或结果**来判断相位早晚，而不是简单地根据边沿极性判断
> - 当前实现仅用于演示CDR环路结构，实际应用需使用完整的BBPD架构（见3.2节）

**步骤4 - PI控制器更新**：根据相位误差更新相位累积量：
```cpp
m_phase += kp * phase_error + ki * phase_error;
```

**步骤5 - 相位范围限制**：将相位输出限制在±range范围内：
```cpp
if (m_phase > range) m_phase = range;
if (m_phase < -range) m_phase = -range;
```

**步骤6 - 输出相位调整**：将相位调整量写入`phase_out`端口，传递给采样器。

> ⚠️ **当前代码实现存在严重Bug**：
> - **正确实现**应该输出相位调整量：`phase_out.write(m_phase);`
> - **当前代码**却输出数据信号：`out.write(current_bit);`（错误！）
> - 这导致CDR模块完全不工作，相位调整信号未被输出
> - 这是关键性错误，必须在后续版本修复（见3.4节问题5）

### 3.2 Bang-Bang相位检测器原理

Bang-Bang相位检测器（BBPD）是一种二值（Binary）相位检测器，通过数据跃变边沿判断采样相位的早晚：

**理想工作原理**：

在数据跃变边沿处，采样得到的数据值反映了采样时刻相对于数据中心的相位关系：
- 如果采样时刻早于数据中心，边沿采样会更接近旧数据
- 如果采样时刻晚于数据中心，边沿采样会更接近新数据

**简化实现**：

当前版本采用简化的边沿极性检测：
```
上升沿（0→1）：认为时钟晚（需要提前） → phase_error = +1
下降沿（1→0）：认为时钟早（需要延后） → phase_error = -1
```

> **注意**：这是简化实现，完整的BBPD需要使用数据采样器（Data Sampler）和边沿采样器（Edge Sampler）进行异或比较。当前实现仅用于演示CDR环路结构。

**完整BBPD架构**（未来版本）：

```
         ┌──────────────┐
data ───→│ Data Sampler │──→ D[n]
  │      └──────────────┘       │
  │                             ↓
  │      ┌──────────────┐    ┌─────┐
  └─────→│ Edge Sampler │──→ │ XOR │──→ phase_error
         └──────────────┘    └─────┘
              (早采样)            ↑
                                  D[n-1]
```

相位误差 = D[n-1] ⊕ Edge[n]：
- 0 ⊕ 0 = 0（无误差或大误差）
- 0 ⊕ 1 = 1（时钟晚）
- 1 ⊕ 0 = 1（时钟早）
- 1 ⊕ 1 = 0（无误差或大误差）

### 3.3 PI控制器设计

PI（比例-积分）控制器是经典的二阶数字环路滤波器，兼顾快速响应和稳态精度。

**离散时间传递函数**：

```
H(z) = Kp + Ki/(1 - z⁻¹)
```

**时域递推公式**：

```cpp
// 比例项：瞬时响应
double prop_term = kp * phase_error;

// 积分项：累积历史误差（当前简化实现未独立记录）
m_phase += ki * phase_error;  // 隐式积分

// 总输出
phase_out = m_phase + prop_term;
```

> **当前实现的问题**：代码中比例项和积分项未正确分离，导致控制器行为不符合标准PI设计。后续版本将修复为：
> ```cpp
> m_integral += ki * phase_error;  // 积分状态
> double phase_out = kp * phase_error + m_integral;  // PI输出
> ```

**环路特性分析**：

对于二阶PI环路，开环传递函数为：
```
G(s) = (Kp × s + Ki) / s²
```

闭环特征方程决定环路稳定性和阶跃响应：
- **自然频率**：ωn = √(Ki × Fs)，决定响应速度
- **阻尼系数**：ζ = Kp / (2 × ωn)，决定过冲和振荡
- **环路带宽**：BW ≈ ωn，决定抖动跟踪能力

推荐设计准则：
- ζ ≈ 0.707（临界阻尼）获得最快无过冲响应
- BW ≈ 数据速率/1000 ~ 数据速率/10000（如10Gbps → 1~10MHz）

**PI控制器的Z域分析**：

在离散时间系统中，PI控制器的Z域传递函数为：
```
H(z) = Kp + Ki × T / (1 - z⁻¹)
```
其中T为采样周期（对于baud-rate CDR，T = UI）。将其转换为差分方程：
```
y[n] = y[n-1] + Kp × (e[n] - e[n-1]) + Ki × T × e[n]
```
这里可以看出：
- **比例项**：Kp × (e[n] - e[n-1])，仅响应误差的变化量
- **积分项**：Ki × T × e[n]，累积所有历史误差

**相位更新速率与数据速率的关系**：

本CDR设计采用baud-rate架构，即每个数据比特触发一次相位检测和更新：
- 数据速率 = 10 Gbps → 相位更新速率 = 10 GHz
- UI = 100 ps → 相位更新周期 = 100 ps
- 环路延迟 = 1 UI（相位误差检测 → PI计算 → 相位应用）

更高的更新速率带来更快的锁定速度和更好的抖动跟踪能力，但也增加了功耗和设计复杂度。某些CDR使用1/2或1/4 baud-rate以降低功耗，但会牺牲跟踪带宽。

**边沿检测阈值选择**：

当前实现使用固定阈值0.5来检测数据跃变，这在以下情况下会失效：
- 信号摆幅不为单位归一化（如CTLE输出为±0.3V）
- 存在直流偏移（如VGA输出共模电压漂移）
- 信号衰减严重（信道损耗导致边沿幅度不足）

**改进方案**：
```cpp
// 自适应阈值检测
double threshold = 0.5 * (max_signal - min_signal);  // 相对于信号摆幅
double edge_detect = std::abs(current_bit - m_prev_bit) > threshold;
```
或者使用峰值检测器动态跟踪信号摆幅，将阈值设置为摆幅的10%~20%。

### 3.4 当前实现的已知问题

**问题1 - 端口命名不一致**：

头文件`rx_cdr.h`声明的端口为`phase_out`，但源文件`rx_cdr.cpp`构造函数中使用了`out`，导致编译错误：
```cpp
// 头文件
sca_tdf::sca_out<double> phase_out;

// 源文件（错误）
RxCdrTdf::RxCdrTdf(...) : ... , out("out") , ... {}

// 应修正为
RxCdrTdf::RxCdrTdf(...) : ... , phase_out("phase_out") , ... {}
```

**问题2 - 缺少`m_prev_bit`成员声明**：

源文件使用了`m_prev_bit`变量但头文件未声明，需要添加：
```cpp
// rx_cdr.h
private:
    double m_prev_bit;  // 前一比特状态
```

**问题3 - PI控制器公式不完整**：

当前实现将比例项和积分项都累加到`m_phase`，导致比例项也被积分：
```cpp
// 当前（错误）
m_phase += kp * phase_error + ki * phase_error;

// 应为
m_integral += ki * phase_error;
double phase_out = kp * phase_error + m_integral;
```

**问题4 - 边沿检测阈值硬编码**：

阈值0.5未考虑实际信号摆幅，应使用可配置参数或自适应检测。

**问题5 - 相位输出函数未实现**：

当前代码在`processing()`的输出步骤中，错误地输出了数据信号而非相位调整量：
```cpp
// 当前（严重错误）
out.write(current_bit);  // 输出了数据信号！

// 正确实现应为
phase_out.write(m_phase);  // 输出相位调整量
```
这是**关键性Bug**，导致CDR的核心功能完全失效，相位反馈环路不工作。

**问题6 - 缺少相位量化到分辨率**：

当前代码直接输出`m_phase`，未量化到配置的`resolution`参数：
```cpp
// 应添加量化步骤
double quantized_phase = std::round(m_phase / resolution) * resolution;
phase_out.write(quantized_phase);
```

> **开发计划**：这些问题将在v0.2版本修复，同时增加频率检测器、锁定检测器等功能。

---

## 4. 测试平台架构

### 4.1 测试平台设计思想

CDR测试平台采用闭环集成设计，需要与采样器模块紧密协同才能验证相位跟踪能力。核心设计理念：

1. **闭环架构**：CDR和Sampler构成相位反馈闭环，相位调整结果直接影响采样质量
2. **场景驱动**：覆盖频率捕获、相位跟踪、抖动容限、锁定检测等关键测试场景
3. **性能评估**：支持BER测试、锁定时间测量、相位误差统计等性能指标
4. **已知问题隔离**：当前实现存在已知bug（见第7章），测试平台应能清晰展示问题并验证修复效果

**与其他模块测试平台的区别**：

- CTLE/VGA等模块可独立测试（开环）
- CDR必须与Sampler组成闭环才能验证功能
- 需要精确控制输入数据的频率偏移和抖动
- 测试指标包括动态特性（锁定时间、跟踪带宽）

### 4.2 测试场景定义

测试平台支持五种核心测试场景，覆盖CDR的主要功能和性能指标：

| 场景 | 命令行参数 | 测试目标 | 输出文件 |
|------|----------|---------|----------|
| PHASE_LOCK_BASIC | `lock` / `0` | 基本相位锁定功能验证 | cdr_tran_lock.csv |
| FREQUENCY_OFFSET | `freq` / `1` | 频率偏移捕获能力 | cdr_tran_freq.csv |
| JITTER_TOLERANCE | `jtol` / `2` | 抖动容限测试（JTOL） | cdr_tran_jtol.csv |
| PHASE_TRACKING | `track` / `3` | 动态相位跟踪能力 | cdr_tran_track.csv |
| LOOP_BANDWIDTH | `bw` / `4` | 环路带宽测量 | cdr_tran_bw.csv |

> **注意**：由于当前实现存在已知bug（见7.4节），部分场景可能无法通过验证。测试平台设计时应考虑debug模式，能够单步跟踪相位检测器和PI控制器的中间状态。

### 4.3 场景配置详解

#### PHASE_LOCK_BASIC - 基本相位锁定测试

验证CDR从初始随机相位锁定到最佳采样相位的基本功能。

- **信号源**：PRBS-15伪随机序列
- **数据速率**：10 Gbps（UI = 100ps）
- **初始相位偏移**：随机（0~UI范围内）
- **PI参数**：Kp=0.01, Ki=1e-4（默认值）
- **仿真时间**：≥10,000 UI（确保环路收敛）
- **验证点**：
  - 相位误差收敛到±5ps以内
  - BER < 1e-12
  - 锁定后相位稳定（无持续振荡）

**期望波形特征**：
- 相位调整信号从初始值单调收敛到稳态值
- 收敛过程呈指数衰减（二阶系统特性）
- 锁定后存在小幅抖动（Bang-Bang PD固有特性）

**调试要点**（针对已知bug）：
- 检查相位检测器输出是否正确反映早/晚信息
- 验证PI控制器的比例项和积分项是否正确分离
- 确认相位输出信号正确连接到采样器

#### FREQUENCY_OFFSET - 频率偏移捕获测试

验证CDR捕获和补偿发送端与接收端频率偏移的能力。

- **信号源**：10 Gbps PRBS-7
- **频率偏移**：±100ppm, ±500ppm, ±1000ppm（分级测试）
- **PI参数**：Kp=0.01, Ki=1e-4
- **PI range**：必须≥ |freq_offset| × UI × 锁定时间
- **仿真时间**：≥50,000 UI
- **验证点**：
  - 系统能否在规定时间内锁定
  - 锁定后相位漂移速率 = 频偏对应的相位斜率
  - 相位调整范围未超出pai.range限制

**物理意义**：

频率偏移导致相位以固定速率累积：
```
相位漂移率 = freq_offset × UI
例如：100ppm @ 10Gbps → 100ps/1e6 UI = 0.1fs/UI
```

CDR的积分项Ki负责跟踪这一恒定相位斜率，如果Ki过小则无法完全消除静态相位误差。

**测试步骤**：
1. 配置发送端频率偏移（通过时钟周期微调）
2. CDR从初始状态启动
3. 记录相位调整信号的时域波形
4. 测量锁定时间（相位误差稳定到±10ps）
5. 验证锁定后的相位斜率是否匹配频偏

#### JITTER_TOLERANCE - 抖动容限测试

验证CDR对输入数据抖动的容忍能力，是SerDes系统的关键性能指标。

- **信号源**：10 Gbps PRBS-31（长序列保证统计有效性）
- **抖动类型**：
  - **随机抖动（RJ）**：高斯分布，σ = 1ps, 2ps, 5ps
  - **周期性抖动（SJ）**：正弦调制，频率扫描（1kHz ~ 100MHz）
  - **组合抖动**：RJ + SJ叠加
- **测试方法**：固定抖动幅度，扫描抖动频率，记录BER
- **PI参数**：Kp=0.01, Ki=1e-4
- **仿真时间**：每个频率点≥1e6 UI（保证BER测量精度）
- **验证点**：
  - 绘制JTOL曲线（抖动容限 vs 频率）
  - 验证低频抖动跟踪能力（频率 < 环路带宽）
  - 验证高频抖动抑制能力（频率 > 环路带宽）

**JTOL曲线特征**：

```
抖动容限（UI）
    ^
1.0 |━━━━━┓                     ← 低频：完美跟踪
    |      ┗━━━━┓                ← 转折频率 ≈ 环路带宽
0.5 |           ┗━━━━┓           ← 斜率 -20dB/decade
    |                ┗━━━━━━━    ← 高频：固有容限
0.1 |________________________
        1k  10k 100k  1M  10M  100M  (Hz)
```

**关键频率点**：
- **低频段（< BW/10）**：CDR完全跟踪抖动，容限 ≈ 1 UI
- **转折频率（≈ BW）**：容限开始下降
- **高频段（> 10×BW）**：CDR无法跟踪，容限由采样器固有裕量决定

#### PHASE_TRACKING - 动态相位跟踪测试

验证CDR对动态相位调制的跟踪能力。

- **信号源**：10 Gbps PRBS-7
- **相位调制**：正弦波调制采样相位
  - 调制频率：100kHz, 1MHz, 10MHz
  - 调制幅度：±10ps, ±20ps, ±50ps
- **PI参数**：Kp=0.01, Ki=1e-4
- **仿真时间**：≥100个调制周期
- **验证点**：
  - 计算跟踪误差（输入相位调制 vs CDR输出相位）
  - 测量跟踪延迟（相位差）
  - 验证环路带宽（-3dB点）

**相位跟踪传递函数**：

CDR环路的闭环传递函数（相位输出/相位输入）具有低通特性：
```
H(f) = (Kp×s + Ki) / (s² + Kp×s + Ki)  （连续域近似）

-3dB带宽 ≈ √Ki  （rad/s）
```

通过扫描调制频率，测量输出/输入幅度比，可绘制传递函数曲线验证理论带宽。

#### LOOP_BANDWIDTH - 环路带宽测量

精确测量CDR环路的实际带宽，验证与理论设计的符合度。

- **测试原理**：向数据流注入已知幅度的相位调制，测量CDR输出的幅度响应
- **调制频率扫描**：10kHz ~ 100MHz（对数间隔，每倍频10个点）
- **调制幅度**：固定20ps（小信号线性范围）
- **PI参数**：多组参数对比（验证Kp/Ki对带宽的影响）
- **输出**：Bode图（幅频响应和相频响应）
- **验证点**：
  - -3dB带宽与理论计算对比（误差应<20%）
  - 相位裕度 > 45°（稳定性指标）
  - 无谐振峰值（阻尼充分）

**测试配置表**：

| Kp | Ki | 理论BW (MHz) | 理论ζ |
|----|-------|-------------|-------|
| 0.005 | 2.5e-5 | 2.5 | 0.707 |
| 0.01 | 1e-4 | 5.0 | 0.707 |
| 0.02 | 4e-4 | 10.0 | 0.707 |

通过对比不同参数组的实际带宽，验证参数调节的有效性。

### 4.4 信号连接拓扑

CDR测试平台的核心是CDR与Sampler的闭环连接：

```
┌─────────────────┐       ┌─────────────────┐       ┌─────────────────┐
│ DiffSignalSource│       │  RxSamplerTdf   │       │   RxCdrTdf      │
│  (PRBS + Jitter)│       │                 │       │                 │
│                 │       │                 │       │                 │
│  out_p ─────────┼───────▶ inp             │       │                 │
│  out_n ─────────┼───────▶ inn             │       │                 │
└─────────────────┘       │                 │       │                 │
                          │  data_out ──────┼───────▶ in              │
                          │                 │       │                 │
                          │  phase_offset ◀─┼───────┤ phase_out       │
                          └─────────────────┘       └─────────────────┘
                                   │                          │
                                   ▼                          ▼
                          ┌─────────────────┐       ┌─────────────────┐
                          │  SamplerMonitor │       │   CdrMonitor    │
                          │  - BER统计      │       │  - 相位波形     │
                          │  - 眼图采集     │       │  - 锁定检测     │
                          └─────────────────┘       └─────────────────┘
```

**关键连接说明**：

1. **差分信号源 → 采样器**：
   - 提供带抖动/频偏的差分数据信号
   - 支持可编程抖动注入（RJ/SJ）
   - 支持可编程频率偏移

2. **采样器 → CDR（前向路径）**：
   - 连接方式取决于CDR输入类型：
     - **方案A**：Sampler.data_out → CDR.in（数字信号）
     - **方案B**：均衡器输出 → CDR.in（模拟信号，需要边沿采样器）
   - 当前简化实现使用方案A

3. **CDR → 采样器（反馈路径）**：
   - CDR.phase_out → Sampler.phase_offset
   - 相位调整单位：秒（s）
   - 正值=延迟采样，负值=提前采样

4. **监控器连接**：
   - SamplerMonitor：统计BER、采集眼图数据
   - CdrMonitor：记录相位调整波形、检测锁定状态

**环路延迟考虑**：

CDR环路存在固有延迟（信号传播+处理延迟），影响环路稳定性：
```
总延迟 = Sampler延迟 + CDR处理延迟 + 相位应用延迟
典型值：1~2 UI
```

测试平台应支持延迟可配置，验证延迟对锁定性能的影响。

### 4.5 辅助模块说明

#### DiffSignalSource - 差分信号源（增强版）

为CDR测试定制的信号源，支持精确的频率和抖动控制：

**波形类型**：
- PRBS-7/15/31：不同长度序列，验证CDR对数据模式的适应性
- Alternating Pattern（010101...）：最大跃变密度，验证相位检测器响应
- Low Transition Density（稀疏跃变）：验证CDR在低跃变率下的保持能力

**抖动注入能力**：

| 抖动类型 | 参数 | 说明 |
|---------|------|------|
| 随机抖动（RJ） | sigma（标准差） | 高斯分布，典型值0.5~5ps |
| 周期性抖动（SJ） | 频率、幅度 | 正弦调制，支持多音叠加 |
| 有界非相关抖动（BUJ） | 峰峰值 | 均匀分布 |
| 占空比失真（DCD） | 偏移量 | 高低电平时间不对称 |

**频率偏移控制**：

通过调整符号周期实现精确频偏：
```cpp
实际UI = 标称UI × (1 + freq_offset_ppm / 1e6)
例如：10Gbps + 100ppm → UI = 100ps × 1.0001 = 100.01ps
```

**配置示例**：
```json
{
  "signal_source": {
    "data_rate": 10e9,
    "pattern": "PRBS31",
    "jitter": {
      "rj_sigma": 2e-12,
      "sj_freq": 1e6,
      "sj_amplitude": 10e-12
    },
    "freq_offset_ppm": 100
  }
}
```

#### SamplerMonitor - 采样器监控模块

监控采样器输出，评估CDR性能对BER的影响：

**功能**：
- **BER实时统计**：比对采样输出与理想参考序列
- **误码位置记录**：时间戳、误码类型（单比特/突发）
- **眼图采集**：记录采样点的幅度和相位分布
- **统计分析**：Q-factor、眼高、眼宽

**输出文件**：
- `sampler_monitor.csv`：逐比特记录（时间、数据、参考、误码标志）
- `ber_summary.json`：BER统计结果和眼图参数

#### CdrMonitor - CDR状态监控模块

专用于CDR内部状态监控和性能分析：

**监控信号**：
| 信号 | 说明 |
|------|------|
| phase_out | 相位调整输出波形 |
| phase_error | 相位检测器输出（内部信号，需调试接口） |
| lock_status | 锁定状态指示（需实现锁定检测器） |
| integral_state | PI控制器积分状态（内部信号） |

**分析功能**：
- **锁定时间测量**：从启动到相位误差<阈值的时间
- **锁定抖动统计**：稳态时相位调整信号的RMS抖动
- **环路响应分析**：阶跃响应、频率响应测量
- **参数优化建议**：基于实测性能推荐Kp/Ki调整

**输出**：
- `cdr_phase.csv`：相位波形数据
- `cdr_performance.json`：性能指标汇总
- `cdr_debug.log`：内部状态日志（debug模式）

**Debug模式特性**：

当前实现存在bug（见7.4节），测试平台应支持debug模式输出中间状态：
```json
{
  "debug_mode": true,
  "debug_signals": [
    "phase_detector_output",
    "proportional_term",
    "integral_term",
    "phase_before_limit",
    "phase_after_limit"
  ]
}
```

这些内部信号的波形对于诊断相位检测器错误和PI控制器bug至关重要。

#### JitterInjector - 抖动注入模块（可选）

独立的抖动注入模块，可插入信号链任意位置：

**应用场景**：
- 在Sampler输入端注入：模拟信道抖动
- 在CDR输入端注入：模拟采样器抖动
- 在时钟路径注入：模拟参考时钟抖动

**注入方式**：
- **时间域调制**：直接调制信号时间轴
- **相位域调制**：调制采样相位（与CDR输出相加）

**配置示例**：
```json
{
  "jitter_injector": {
    "enable": true,
    "type": "sinusoidal",
    "frequency": 1e6,
    "amplitude": 20e-12,
    "insertion_point": "sampler_input"
  }
}
```

---

## 5. 仿真结果分析

> **待完成**：本章节将在测试平台开发完成后补充典型的CDR锁定过程、抖动容限测试等仿真结果。

---

## 6. 运行指南

> **待完成**：本章节将在测试平台开发完成后补充完整的构建和运行指南。

---

## 7. 技术要点

### 7.1 环路稳定性设计

CDR环路是典型的反馈控制系统，稳定性设计至关重要：

**二阶系统特性**：

PI控制器构成二阶环路，其阻尼系数ζ决定稳定性：
- **ζ < 0.5**：欠阻尼，快速响应但有过冲和振荡
- **ζ = 0.707**：临界阻尼，最快无过冲响应（最优）
- **ζ > 1.0**：过阻尼，无过冲但响应慢

**Kp和Ki的关系**：

给定目标阻尼系数ζ和环路带宽BW，反推PI参数：
```
ωn = 2π × BW
Ki = ωn² / Fs
Kp = 2 × ζ × ωn
```

> ⚠️ **示例计算的注意事项**：
> 
> 以下示例计算基于**线性相位检测器**的连续域模型推导，但本模块使用的是**Bang-Bang相位检测器**，其非线性特性导致实际参数需要调整。以下公式仅供**初步估算**，实际设计需通过仿真验证。
>
> **示例计算**（10Gbps系统，目标BW=5MHz，ζ=0.707）：
> ```
> ωn = 2π × 5e6 = 3.14e7 rad/s
> Ki = (3.14e7)² / 10e9 = 9.8e-5
> Kp = 2 × 0.707 × 3.14e7 / 10e9 = 0.0044
> ```
> 
> **或者**，如需删除此计算示例以避免混淆，可直接提醒用户：
> "由于Bang-Bang PD的非线性特性，建议通过SystemC-AMS仿真调优Kp/Ki参数，而非依赖线性化公式。"

### 7.2 Bang-Bang PD的抖动性能

Bang-Bang相位检测器的离散特性会引入环路抖动：

**随机抖动（RJ）来源**：
- PD输出为离散的±1，缺乏线性区间
- 每次更新都是"过校正"，导致相位在最佳点附近抖动
- 抖动幅度与环路增益成正比：σφ ≈ √(Kp / Fs)

**降低抖动的方法**：
1. 降低环路带宽（减小Kp/Ki）
2. 使用线性相位检测器（如Hogge PD）替代Bang-Bang PD
3. 增加相位检测器分辨率（多级量化）

**Bang-Bang PD的优势**：
- 结构简单，硬件开销小
- 对输入信号幅度不敏感
- 适用于高速链路（40Gbps+）

### 7.3 相位插值器分辨率选择

相位插值器分辨率影响CDR的精度和硬件成本：

**分辨率与UI的关系**：

典型设计中，相位插值器分辨率为UI的1/64~1/256：
- **高精度**（UI/256）：σφ < 0.5ps，适用于56G/112G PAM4
- **中等精度**（UI/128）：σφ ≈ 1ps，适用于10G/25G NRZ
- **低精度**（UI/64）：σφ ≈ 2ps，适用于低成本应用

**默认值选择**（1ps）：

项目默认1ps（1e-12秒）对应UI/100（假设10Gbps，UI=100ps）：
- 提供足够的相位调整精度
- 模拟中高端SerDes实现
- 可通过配置调整为更粗糙的分辨率（5ps）模拟低成本方案

**量化噪声**：

分辨率越粗，量化噪声越大：
```
σ_quantization ≈ resolution / √12
```
对于1ps分辨率，量化噪声约0.29ps RMS。

### 7.4 与采样器模块的接口设计

CDR的`phase_out`端口必须与采样器的`phase_offset`端口正确连接：

**单位约定**：

- CDR输出：时间偏移量，单位**秒（s）**
- 采样器接收：相位偏移量，单位**秒（s）**
- 物理含义：正值延迟采样，负值提前采样

**时序协调**：

CDR和采样器工作在相同的采样率（Fs），确保：
```cpp
// 两者必须设置相同采样率
cdr.set_attributes() {
    in.set_rate(1);
    phase_out.set_rate(1);
}

sampler.set_attributes() {
    phase_offset.set_rate(1);
    // ...
}
```

**相位更新延迟**：

实际硬件中，CDR相位更新到采样器有延迟（1~2个周期），当前模型未考虑此延迟。若需要更精确建模，可在CDR模块内部增加延迟缓冲器。

### 7.5 频率捕获（未实现功能）

当前版本未实现频率捕获功能，仅适用于发送端和接收端频率已近似匹配的场景。

**频率检测器的必要性**：

实际SerDes中，参考时钟频偏可达±100ppm，对应10Gbps系统为±1MHz。若仅靠相位环路跟踪，会导致：
- 相位累积量持续增大，超出相位插值器范围
- 环路无法锁定

**频率辅助方案**（未来版本）：

1. **旋转频率检测器**（Rotational Frequency Detector）：
   - 监测相位累积量的变化率
   - 输出频率误差信号到VCO或PLL

2. **双环架构**：
   - 低带宽频率环（kHz级）：跟踪频偏
   - 高带宽相位环（MHz级）：跟踪抖动

3. **锁定检测器**：
   - 监测相位误差的方差
   - 当方差小于阈值时，声明锁定

### 7.6 采样率要求

CDR模块的采样率必须与数据速率匹配：

**推荐设置**：

对于baud-rate CDR（每个符号一次相位更新）：
```cpp
// SystemC-AMS TDF模块采样率设置
void RxCdrTdf::set_attributes() {
    set_timestep(UI);  // 采样时间步长 = 单位间隔
}
```

对于10Gbps NRZ（UI=100ps）：
- CDR采样率 = 10 GHz
- 每个比特触发一次相位检测和环路更新

**过采样CDR**（未来扩展）：

某些CDR设计使用2×或4×过采样以提高相位检测精度，但会增加功耗和复杂度。

### 7.7 已知限制与注意事项

**限制1 - 简化的相位检测**：

当前实现未使用真实的数据/边沿采样器架构，相位检测精度有限。实际应用中应替换为完整的BBPD实现。

**限制2 - 缺少频率检测**：

无法处理大频偏情况（>100ppm）。若需要模拟参考时钟频偏，需先手动调整PLL模块的输出频率。

**限制3 - 无锁定检测**：

模块不输出锁定状态信号，无法判断CDR是否成功锁定。建议在测试平台中监测`phase_out`信号的方差。

**限制4 - 线性相位范围**：

当相位累积量超出±range时，会硬限幅，导致暂时失去跟踪能力。实际设计中应通过频率检测器避免此情况。

**注意事项**：

- 调整Kp/Ki时，需同时检查阻尼系数和带宽，避免不稳定
- 相位范围应大于预期最大频偏 × UI
- Bang-Bang PD在低信噪比时性能下降，建议配合DFE使用

---

## 8. 参考信息

> **待完成**：本章节将在测试平台开发完成后补充完整的文件路径、配置示例和依赖项信息。

---

**文档版本**：v0.1.0  
**最后更新**：2026-01-07  
**作者**：Qoder serdes-doc-writer